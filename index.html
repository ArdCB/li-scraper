<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LinkedIn Activity → Excel</title>

  <link rel="stylesheet" href="style.css" />

  <!-- PyScript runtime -->
  <link rel="stylesheet"
        href="https://pyscript.net/releases/2024.1.1/core.css" />
  <script type="module"
          src="https://pyscript.net/releases/2024.1.1/core.js"></script>

  <py-config>
    packages = ["beautifulsoup4", "openpyxl", "pandas"]
    [[fetch]]
    files = ["social_html_scraper_txt.py"]
  </py-config>
</head>

<body>
  <h1>LinkedIn Activity → Excel</h1>
  <p>Choose a saved LinkedIn <em>.html</em> activity page (posts or comments):</p>

  <input type="file" id="file-input" accept=".html" />
  <button id="convert-btn">Convert&nbsp;⇨</button>
  <a id="download-link" style="display:none"></a>

  <!-- controller -->
<py-script>
import js, base64, traceback, re
from datetime import datetime
from pyodide.ffi import create_proxy
from social_html_scraper_txt import linkedin_html_to_excel, detect_mode

# ── DOM elements ──────────────────────────────────────────────────────────
file_el      = js.document.getElementById("file-input")
convert_btn  = js.document.getElementById("convert-btn")
download_el  = js.document.getElementById("download-link")

convert_btn.disabled = True          # stay inactive until a file is chosen

def on_select(evt=None):
    convert_btn.disabled = (file_el.files.length == 0)
file_el.onchange = create_proxy(on_select)

# ── main coroutine ────────────────────────────────────────────────────────
async def convert(evt=None):
    try:
        if file_el.files.length == 0:
            return                        # no file selected

        # 1. read the uploaded HTML
        fobj       = file_el.files.item(0)          # JsProxy → File
        html_text  = await fobj.text()

        # 2. run the scraper (auto‑detects posts vs comments)
        xlsx_bytes = linkedin_html_to_excel(html_text)
        b64        = base64.b64encode(xlsx_bytes).decode()

        # 3. compose a friendly download filename
        mode       = detect_mode(html_text)               # "posts" or "comments"
        timestamp  = datetime.now().strftime("%Y%m%d_%H%M%S")

        # extract the profile name between "Activity" and "LinkedIn" in the original filename
        m          = re.search(r"Activity\s*_?\s*(.*?)\s*_?\s*LinkedIn", fobj.name, re.I)
        person     = m.group(1).strip().replace(" ", "_") if m else "output"

        filename   = f"social_{mode}_{timestamp}_{person}.xlsx"

        # 4. expose the download link
        download_el.href          = ("data:application/vnd.openxmlformats-"
                                     "officedocument.spreadsheetml.sheet;base64," + b64)
        download_el.download      = filename
        download_el.textContent   = f"Download “{filename}”"
        download_el.style.display = "inline"

    except Exception as e:
        # surface the traceback in the console for easier debugging
        js.console.error("Conversion failed:", traceback.format_exc())
        download_el.style.display = "none"

convert_btn.onclick = create_proxy(convert)
</py-script>
</body>
</html>
